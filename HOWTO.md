# How to successfully retrieve a SAMLToken

## Step 1 - Add certificates

### Ehealth certificates from examples

* Download [connector-packaging-persphysiotherapist-3.15.1-java](http://repo.ehealth.fgov.be/artifactory/webapp/#/artifacts/browse/tree/General/maven2-cache/be/fgov/ehealth/connector/connector-packaging-persphysiotherapist/3.15.1/connector-packaging-persphysiotherapist-3.15.1-java.zip) from the [eHealth Artifcatory](http://repo.ehealth.fgov.be/), and unpack it somewhere.
* Copy paste the contained jks files located in `config/P12/acc` to the `keystore` folder.

### Configure your own certificates
After having filled in a valid request form, [_procuratie formulier_](https://www.ehealth.fgov.be/ehealthplatform/nl/data/file/view/d59a4ab71055c5b46894b8e5388d79b5b83bc10e?name=Procuration%20Form%20eHealthTestCert_Nl.pdf), that got a positive response.

Download and execute the [ehealth certificate tool](http://wwwacc.ehealth.fgov.be/JWS/ETEE/etee-requestor_nl.jnlp).

This is a Java WebStart application, that requires :
* the **Java 8 Runtime** (higher versions don't work yet)
* an installed [Belgian eID application](https://eid.belgium.be/en)
* and an [eID Reader](http://www.belgeid.be/en/product/acr38) (hardware device)

We tried the Belfius card reader, but that didn't work.

You can follow along with the procedure you can find on [the eHealth website](https://www.ehealth.fgov.be/ehealthplatform/nl/service-ehealth-certificaten), under [_Procedure voor het verkrijgen van een acceptatie-certificaat_](https://www.ehealth.fgov.be/ehealthplatform/nl/data/file/view/3ec89765fe3302d061156fc1f02960dcf8860444?name=ehealthcertificatstest_nl_060204.pdf).

This will eventually generate a p12 file, the actual _personal eHealth certificate_.

Use the p12 file generated by the ehealth certificate tool (see above), paste it in the same keystore folder, it will look something like `SSIN= <yourSSIN> 20180424-165659.acc-p12`

### Copying root (CA) certificates locally should not be necessary
Normally you can find these root certificates on [the eHealth website](https://www.ehealth.fgov.be/ehealthplatform/nl/service-ehealth-certificaten) under [the _Keystore_, _Acceptatie_ zip file](https://www.ehealth.fgov.be/ehealthplatform/nl/data/file/view/7cec2053798305ef5ad1820c7f0b4130cc44ae1b?name=acceptation.zip).

Once downloaded, you can find these certificates here; `acceptation/other/QuoVadis_ICAG*` certificates.

The reason you don't need this is because these root certificates are contained within the `tslostore.jks` keystore.

## Step 2 - Adjust configuration file

We copied the `config/be.ehealth.technicalconnector.properties` file from the zip above, and renamed it to [ehealth-default.properties](src/main/resources/ehealth-default.properties).

Then we copied the `ehealth-default.properties` file to a personal one, that will contain your personal credentials and the location of your personal ehealth certificate (generated above).
This is the file we'll be using in our test application.

### Properties to adjust
* `KEYSTORE_DIR`: this should point to the directory where your keystores and certificates are located at. (in our project this would be `keystore`)
* `user.firstname`: Information defining **you**
* `user.lastname`: Information defining **you**
* `user.inss`: Information defining **you**
* `user.nihii`: This property should be set as provided by eHealth. It's the NihiiNumber (_RIZIV Nummer_) that was assigned by eHealth, which identifies _you_ as a known careprovider in the ACC environment.


* `sessionmanager.holderofkey.keystore`: this should point to the p12 file that was generated by the ehealth certificate tool, which we pasted into the keystore folder.
* `sessionmanager.identification.keystore`: this should point to the p12 file that was generated by the ehealth certificate tool, which we pasted into the keystore folder.
* `sessionmanager.encryption.keystore`: this should point to the p12 file that was generated by the ehealth certificate tool, which we pasted into the keystore folder.


* `main.kmehr.quality`: this property should contain `trussmaker` instead of persphysiotherapist
* `mycarenet.default.careprovider.nihii.quality`: this property should contain `trussmaker` instead of persphysiotherapist


For the `sessionmanager.samlattributedesignator.3` property we replaced
```
urn:be:fgov:person:ssin:ehealth:1.0:nihii:physiotherapist:nihii11
```
with
```
urn:be:fgov:person:ssin:ehealth:1.0:nihii:trussmaker:nihii11
```

We removed this line: `sessionmanager.samlattributedesignator.4=urn:be:fgov:certified-namespace:ehealth,urn:be:fgov:person:ssin:ehealth:1.0:professional:physiotherapist:boolean`.

With this configuration we were able to successfully retrieve a SAMLToken, by running the `EhealthApplication` with your personal property file configured in the `be.Tester` class:
```
ConfigFactory.setConfigLocation("classpath:ehealth_ken.properties");
```